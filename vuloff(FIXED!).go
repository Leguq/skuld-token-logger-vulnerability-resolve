package main

import (
    "log"
    "time"
    "golang.org/x/sys/windows/svc"
    "golang.org/x/sys/windows/registry"
)

// myService represents the service structure
type myService struct{}

// Execute handles service commands
func (m *myService) Execute(args []string, r <-chan svc.ChangeRequest, s chan<- svc.Status) (bool, uint32) {
    const cmdsAccepted = svc.AcceptStop | svc.AcceptShutdown
    s <- svc.Status{State: svc.StartPending}
    go m.run() // Start the monitoring function
    s <- svc.Status{State: svc.Running, Accepts: cmdsAccepted}

    for c := range r {
        switch c.Cmd {
        case svc.Stop, svc.Shutdown:
            s <- svc.Status{State: svc.StopPending}
            return false, 0
        }
    }
    return false, 0
}

// run is the monitoring function that checks the registry
func (m *myService) run() {
    for {
        monitorRegistryKey() // Call your registry monitoring function
        time.Sleep(2 * time.Second)
    }
}

// monitorRegistryKey is a placeholder function for monitoring registry keys
func monitorRegistryKey() {
    key, err := registry.OpenKey(registry.CURRENT_USER, `Software\Classes\ms-settings\shell\open\command`, registry.READ)
    if err != nil {
        log.Printf("Error opening registry key: %v", err)
        return
    }
    defer key.Close()

    // Perform your registry monitoring logic here
    log.Println("Registry key exists and is being monitored.")
}

func main() {
    isInteractive, err := svc.IsAnInteractiveSession()
    if err != nil {
        log.Fatalf("failed to determine if we are running in an interactive session: %v", err)
    }
    if isInteractive {
        // Run as a console application for debugging
        s := &myService{} // Create a pointer to myService
        s.run()
    } else {
        // Run as a service
        err = svc.Run("MyRegistryMonitorService", &myService{})
        if err != nil {
            log.Fatalf("failed to run service: %v", err)
        }
    }
}
